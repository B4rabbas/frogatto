//object which represents a single text glyph. Give it a font and a char to make an object
//representing that text.
//example usage: map(glyphs, [set(value.y, 100), set(value.x, 100+sum(widths[:index])), add_object(value)]) where widths = map(glyphs, value.img_w) where glyphs = map(text, object('text_glyph', { font: 'title_font', char: value, zorder: 1000 })) where text = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
{
	id: "text_glyph",
	is_strict: true,
	use_absolute_screen_coordinates: true,

	types: {
		GlyphInfo: "{chars: string, width: null|int, rect: [int,int,int,int]|null}",
		FontInfo: "{texture: string, kerning: int, pad: int, glyphs: { string -> [int,int,int,int] } }",
	},

	properties: {
		font: { type: "string" },
		char: { type: "string" },

		scaling: { type: "decimal", default: 1.0 },

		_calculate_glyph_rect: "def([GlyphInfo] glyphs, int pad, int n) ->[int,int,int,int]
		if(glyph_info.rect, glyph_info.rect,

			[xpos, anchor_rect[1], xpos+ (int<-glyph_info.width), anchor_rect[3]]

			
			where xpos = anchor_rect[2] + spacing
			where spacing = sum(map(filtered_glyphs, pad + (int<- value.width)))
			where filtered_glyphs = glyphs[index(glyphs, anchor)+1:n]
			//anchor at the last glyph to have a defined rect
			where anchor_rect = [int,int,int,int]<- anchor.rect
			where anchor = find_or_die(reverse(glyphs[:n+1]), value.rect != null)
		)
		where glyph_info = glyphs[n]
		",

		get_font: "def(string id) ->FontInfo query_cache(global_cache(), id,
			{
				kerning: kerning,
				pad: pad,
				glyphs: glyphs,
				texture: string<- font_info.texture,
			}

			where glyphs = fold(map(single_glyph_chars, { (value.chars): _calculate_glyph_rect(single_glyph_chars, pad, index) }), a+b, {})

			//expand out into one glyph per entry
			where single_glyph_chars = fold(map(chars, if(size(value.chars) = 1, [value], map(value.chars, context.value + {chars: value}))), a+b, [])

			where chars = [GlyphInfo]<- font_info.chars
			where kerning = int<- font_info.kerning
			where pad = int<- font_info.pad
			where font_info = find_or_die([map]<- info.font, value.id = id)
			where info = {font: [map]}<- get_document('data/fonts.cfg')
		)",
	},

	events: {
		construct: "
		set(animation, {
			id: 'normal',
			image: font_info.texture,
			x: area[0],
			y: area[1],
			w: area[2] - area[0],
			h: area[3] - area[1],
			scale: scaling,
			frames: 1,
			duration: -1,
		})
		where area = font_info.glyphs[char] asserting char in font_info.glyphs
		where font_info = get_font(font)
		",
	},
}
