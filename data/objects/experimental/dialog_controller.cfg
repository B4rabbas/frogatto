{
id: "dialog_controller",
always_active: true,
is_strict: true,
hidden_in_game: true,
prototype: ["standard_values"],
zorder: "@include data/zorder.cfg:in_front_of_everything",

/*
	A controller to help with making things talk in a reasonable way.
	Hopefully, more information is up on the wiki at
		https://github.com/frogatto/frogatto/wiki/dialog-controller
	
	Definitions:
		line:   One physical line of text in the dialog box. Not really related
		        to a sentence, because long sentences can take multiple lines to
		        display. Generated from parts.
		part:   A collection of sentences that a speaker says without
		        interruption. Marked up with XML.
		page:   The visual panel in which lines are drawn. Multiple lines can
		        appear on a page, and pressing a key will display the next line
		        in the part or advance the script.
		script: A collection of XML, actors (anything that's reasonably a point
		        on the level, like an object or some coordinates), and commands.
	
	Markup Guide:
		<br/>, \\n - Hard return. Enter replacement. You should almost always
			just use enter anyway, the leading whitespace gets trimmed. Text 
			that is too long to fit on a line is automatically wrapped.
		<page/> - Page feed. Regardless of if the page is full, advance to a 
			new page before displaying the next line.
		<pause time="200ms" />, \\p - Pause for a moment before displaying the
			next character.
		\\s - Sometimes, you do want leading whitespace. Use \\s to prevent 
			trimming of any following whitespace on a line.
		<b>text</b> or <strong>text</strong> - bold text
		<i>text</i> or <em>text</em> - italicised text
		<word-by-word>text</word-by-word> - Make the text appear word by word 
			instead of letter by letter. Usually indicates the speaker IS. 
			VERY. ANGRY. (Words are whitespace-delimited. You may use a 
			no-break space, i.e. « », if you want to join multiple words.)
		
		You can also add more effect tags yourself, by adding them to your 
			module's ~data/dialog_effect_tags.cfg file.
*/

editor_info: {
	category: "controllers",
	help: "A controller to assist with dialog. Script it in the level file."
},

properties: {
	custom_storage: { type: "{string -> any}", default: {} },
	
	//Overwrite these with your own npc types in your module with @derive.
	cast: { 
		type: "{string -> obj standing_npc | obj player_controlled_platformer_character}", 
		default: {},
	},
	props: { type: "{string -> custom_obj}", default: {} },
	script: { 
		type: "[commands]", 
		init: "[ //This provides a silly little default speech. You can do better – go write your own! :)
			part(level.player, 'I don\'t <i>really</i> know what to say here.'), 
			sleep(1), 
			part(level.player, 'I guess that\'s it.'),
			sleep(1),
			part(level.player, 'There is no more.'),
		]",
	},
	_parsed_script: { type: "[commands]", default: [] },
	camera: "object('camera_controller')",
	
	before_script: { type: "commands", default: [] },
	after_script: { type: "commands", default: [] },
	
	zoom: { type: "decimal", default: 2 }, //something like this
	
	lines_per_page: 2,
	dialog_type: { type: "DialogType", default: "@eval enum debug" },
	
	playing: { type: "bool", default: false },
	skip_dialog: { type: "bool", default: false },
	
	line: "def(custom_obj actor, XMLString lines) -> commands",
	
	//display_line: "def(XML line) -> commands 
	//	debug(line); 
	//	sleep(0.5)",
	//
	//display_lines: "def(XML part) -> commands 
	//	break_into_lines(lines)
	//",
	//
	//break_into_lines: "def(XMLString part) -> XML
	//	flatten(
	//		map(
	//			map(
	//				split(part, '<br/>'), 
	//				map(
	//					value, 
	//					value.split('\\n')
	//				)
	//			),
	//			
	//		)
	//	)
	//",
	
	parse_part: "def(XMLString part) -> XMLTokenList
		XMLTokenList <- parse_xml('<root>'+part+'</root>') //Returns a string on error.
	",
},

on_create: "
	debug('hi');
",

on_triggered: "
	before_script;
	
	set(camera.target_zoom, zoom);
	camera.add();
	
	
	run_script();
	
	
	camera.remove();
	
	after_script;
",


animation: {
	id: "normal",
	image: "effects/particles.png",
	x: 86, y: 73, w: 28, h: 28,
	duration: -1,
},
}